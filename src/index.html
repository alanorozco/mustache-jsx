<title>mustache-jsx</title>
<link
  rel="icon"
  href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®üèª</text></svg>"
/>
<script src="lib/htmlminifier.js"></script>
<script src="https://unpkg.com/prettier@2.1.2/standalone.js"></script>
<script src="https://unpkg.com/prettier@2.1.2/parser-babel.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.12.3/babel.min.js"></script>
<style>
  body {
    margin: 0;
    font-size: 15px;
    font-family: "Cascadia Code", "Fira Code", Menlo, Consolas, monospace;
    line-height: 1.5;
    overflow: hidden;
  }
  main {
    display: flex;
    height: 100%;
    background: #aaa;
  }
  main > * {
    flex: 1;
    flex-direction: column;
    display: flex;
    margin: 0 0 0 -1px;
    border: 1px solid #ddd;
    border-width: 0 1px;
  }
  textarea,
  h3,
  select {
    font: inherit;
  }
  textarea {
    padding: 0 16px 0;
    resize: none;
    flex: 1;
    outline: none;
    opacity: 0.8;
    border-width: 52px 0;
    border-color: white;
    background: white;
    white-space: pre;
    overflow-wrap: nowrap;
  }
  main > * > div {
    flex: 1;
  }
  h3 {
    padding: 16px 16px 0;
    margin: 0;
    position: absolute;
    z-index: 1;
  }
  textarea:focus {
    opacity: 1;
  }
  textarea::before {
    display: block;
    content: attr(data-label);
  }
  .error {
    color: rgb(248, 17, 82);
  }
  select {
    padding: 4px;
    margin: -4px 0 0 -4px;
  }
</style>
<main>
  <div>
    <h3>mustache</h3>
    <textarea></textarea>
  </div>
  <div>
    <h3>
      <select>
        <option>javascript</option>
        <option>jsx</option>
      </select>
      <label for="excess-fragment">
        <input type="checkbox" name="excess-fragment" id="excess-fragment" />
        excess fragments
      </label>
    </h3>
    <textarea readonly></textarea>
  </div>
</main>
<script>
  self.DEFAULT_TEMPLATE = `<div>
  {{#items}}
    <div>
      <h3>{{name}}</h3>
    </div>
  {{/items}}
  {{^items}}
    empty list
  {{/items}}
</div>
`;
</script>
<script type="module">
  import Writer from "./mustache-jsx.mjs";
  import babelPluginJsxExcessFragment from "./babel-plugin-jsx-excess-fragment.mjs";

  const jsx = {
    pragma: "h",
    pragmaFrag: "Fragment",
  };

  const prettierConfig = {
    parser: "babel",
    plugins: prettierPlugins,
    printWidth: 80,
  };

  const envelope = (out) =>
    `
    const section = ref => (Array.isArray(ref) ?
      (ref.length > 0 ? ref : []) :
      (ref ? [ref] : [])
    );

    const inverted = ref => (!ref || (Array.isArray(ref) && ref.length === 0));

    (view, ${jsx.pragma}, ${jsx.pragmaFrag}, html) => (${out})`;

  const defaultWriter = new Writer();

  const [template, output] = document.querySelectorAll("textarea");

  const leaveExcessFragments = () =>
    document.querySelector("[name=excess-fragment]").checked;

  const toMustacheXhtml = (html) => {
    const parsed = new DOMParser().parseFromString(html, "text/html");
    const serialized = new XMLSerializer().serializeToString(parsed);
    return /<body>([\s\S]*)<\/body>/im.exec(serialized)[1];
  };

  function update() {
    const rendered = envelope(
      defaultWriter.render(toMustacheXhtml(template.value), {})
    );
    try {
      const code =
        document.querySelector("select").value === "javascript"
          ? Babel.transform(rendered, {
              presets: ["es2016", ["react", jsx]],
              plugins: leaveExcessFragments()
                ? null
                : [[babelPluginJsxExcessFragment, jsx]],
            }).code
          : rendered;
      output.classList.remove("error");
      output.textContent = prettier.format(code, prettierConfig);
    } catch (e) {
      output.classList.add("error");
      output.textContent = e.message;
      console.error(e);
    }
  }

  template.value = DEFAULT_TEMPLATE;

  template.addEventListener("keyup", update);
  document
    .querySelector("select")
    .addEventListener("change", ({ currentTarget }) => {
      update();
      const excessFragment = document.querySelector("[for=excess-fragment]");
      if (currentTarget.value !== "javascript") {
        excessFragment.setAttribute("hidden", "");
      } else {
        excessFragment.removeAttribute("hidden");
      }
    });
  document.querySelector("[type=checkbox]").addEventListener("change", update);

  update();
</script>
